/*
 * ARC.c
 *
 *  Created on: Nov 13, 2022
 *      Author: hcwon
 */

#include "main.h"

#include "can.h"
#include "dma.h"
#include "gpio.h"
#include "i2c.h"
#include "spi.h"
#include "tim.h"
#include "usart.h"

#include "camera/camera.h"
#include "lcd/lcd.h"
#include "lcd/lcd_graphics.h"


#define FORWARD 0
#define BACKWARD 1

#define LEFT 0
#define RIGHT 1

//motor direction
#define IN1  GPIO_PIN_8
#define IN2  GPIO_PIN_9
#define IN3  GPIO_PIN_10
#define IN4  GPIO_PIN_11

//gpio with timer (PWM)
#define servo TIM5->CH1
#define left_motor TIM11->CH1
#define right_motor TIM10->CH1

int main(void) {
	HAL_Init();
	SystemClock_Config();

	//define pins to use
	MX_GPIO_Init();

	MX_TIM5_Init(); 

	MX_TIM10_Init();
	MX_TIM11_Init();

	MX_USART2_UART_Init();

	// Init camera
	camera_GPIO_init();
	//cam_set_colormode(CamColorMode c);
	//cam_set_frameSize(CamFrameSize f);
	//cam_set_brightness(int8_t brightness);
	//cam_set_contrast(int8_t contrast);
	//cam_set_framerate(CamFrameRate rate);
	
	tft_prints(0, 0, "Initing camera");
	tft_update(0);
	if (camera_init() == CAM_NOT_INITED || camera_init() == CAM_INIT_ERROR) {
		tft_prints(0, 0, "No OV7725 module");
	} else {
		tft_prints(0, 0, "Inited");
		cam_set_state(CAM_CAPTURING);
	}
	tft_update(0);
	cam_set_window(0, 0, QQVGA_120x160);
	cam_set_framerate(CAM_75FPS);
	
	
	TIM5->ARR = 839;
	TIM10->ARR = 839;
	TIM11->ARR = 839;
	
	while(1){
	    for (uint16_t j = 1; i < IMG_HEIGHT-1; i += IMG_WIDTH) {
		if (image[(IMG_WIDTH/2)+j] = image[1+j]){ // turn right
		    gpio_set(IN1);
				gpio_reset(IN2);
				gpio_reset(IN3);
				gpio_set(IN4);
		}
		else if (image[(IMG_WIDTH/2)+j] == image[(IMG_WIDTH-1)+j]){ // turn left
		    gpio_reset(IN1);
				gpio_set(IN2);
				gpio_set(IN3);
				gpio_reset(IN4);
		}
		else{ 
		    gpio_reset(IN1);
				gpio_set(IN2);
				gpio_reset(IN3);
				gpio_set(IN4);
		}
	    }    
	}
	
}
